<%- include('admin_header')-%>
    <%- include('admin_sidebar')-%>

        <div class="main-content">
            <div class="container-fluid mt-4 pt-2 mb-6">
                <!-- header -->
                <div class="d-md-flex align-items-center">
                    <h3 class="mb-3 mb-md-0">Products</h3>
                    <a href="/admin_product_add_get"
                        class="btn btn-purple hover-lift-light shadow-light-sm ms-auto me-3">
                        <span class="svg-icon svg-icon-sm text-white me-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                                <title>ionicons-v5-a</title>
                                <line x1="256" y1="112" x2="256" y2="400" style="
                  fill: none;
                  stroke: #000;
                  stroke-linecap: round;
                  stroke-linejoin: round;
                  stroke-width: 32px;
                " />
                                <line x1="400" y1="256" x2="112" y2="256" style="
                  fill: none;
                  stroke: #000;
                  stroke-linecap: round;
                  stroke-linejoin: round;
                  stroke-width: 32px;
                " />
                            </svg>
                        </span>
                        Add Products
                    </a>
                </div>

                <!-- report -->
                <div id="companies" class="card mt-4">

                    <div class="table-responsive table-responsive-sm">
                        <table class="table table-sm card-table table-nowrap">
                            <thead>
                                <tr>
                                    <th class="text-center">Order Id</th>
                                    <th class="text-center">
                                        Ordered Products
                                    </th>
                                    <th class="text-center">Ordered Date</th>
                                    <th class="text-center">Delivery Address</th>
                                    <th class="text-center">Total Amount</th>
                                    <th class="text-center">Payment Method</th>
                                    <th class="text-center">Delivery Status</th>
                                </tr>
                            </thead>
                            <tbody class="list">
                                <% orders.forEach(order => {%>
                                    <tr>
                                        <td class="text-center">
                                            <%= order.orderId%>
                                        </td>
                                        <td class="text-center">
                                            <%order.product.forEach(product =>{%>
                                                <p><%= product.name%></p>
                                            <%})%>
                                        </td>
                                        <td class="text-center">
                                            <%= order.date.toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }) %>
                                        </td>
                                        <td class="text-center">
                                            <% users.forEach(user=>{%>
                                                <% user.address.forEach(address => {%>
                                                    <% if(address._id == order.address){%>
                                                        <p><%= address.name%> <br>
                                                            <%= address.email%> <br>
                                                            <%= address.phoneNo%> <br>
                                                            <%= address.streetAddress %> <br>
                                                            <%= address.city%> <br>
                                                            <%= address.pinCode%> <br>
                                                            <%= address.state%>
                                                        </p>
                                                    <%}%>
                                                <%})%>
                                            <%})%>
                                        </td>
                                        <td class="text-center">
                                            <span>â‚¹</span>
                                            <%=order.total%>
                                        </td>
                                        <td class="text-center">
                                            <%= order.paymentMethod%>
                                        </td>
                                        <td class="text-center">
                                            <select class="status-select" data-order-id="<%= order._id %>">
                                                <% const statuses = ["Pending", "Shipped", "Delivered"]; %>
                                                <% statuses.forEach(status => { %>
                                                  <option value="<%= status %>" <%= order.status === status ? 'selected' : '' %>><%= status %></option>
                                                <% }); %>
                                              </select>
                                        </td>
                                    </tr>
                                <%})%>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <%- include('admin_footer')-%>

        <script src="/js/axios.min.js"></script>
        <script>
           document.querySelectorAll('.status-select').forEach(select =>{
            select.addEventListener('change', async (event) => {
                try{
                    const newStatus = event.target.value;
                    const orderId = event.currentTarget.dataset.orderId;
                    const response = await axios.post('/admin_order_status_post',{newStatus, orderId});
                }catch(err){
                    console.log(err);
                }
            })
           })
        </script>