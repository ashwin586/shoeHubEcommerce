<%-include('header') -%>
  
</div>
  <div class="container">
    <div class="row" style="margin-top: 10%">
      <!--Sidebar-->
      <div class="col-12 col-sm-12 col-md-3 col-lg-3 sidebar filterbar">
        <div class="closeFilter d-block d-md-none d-lg-none">
          <i class="icon icon anm anm-times-l"></i>
        </div>
        <div class="sidebar_tags">
          <!--Categories-->
          <div class="sidebar_widget categories filter-widget">
            <div class="widget-title">
              <h2>Categories</h2>
            </div>
            <div class="widget-content">
              <ul class="sidebar_categories">
                <%categories.forEach(category=> {%>
                  <li class="level1" data-categoryid="<%=category._id%>">
                    <a href="#" class="site-nav categoryLink">
                      <%= category.categoryName%>
                    </a>
                  </li>
                  <%})%>
              </ul>
            </div>
          </div>
          <!--Categories-->
          <!--Price Filter-->
          <div class="sidebar_widget filterBox filter-widget">
            <div class="widget-title">
              <h2>Price</h2>
            </div>
            <form action="#" method="post" class="price-filter">
              <div id="slider-range" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">
                <div class="ui-slider-range ui-widget-header ui-corner-all"></div>
                <span class="ui-slider-handle ui-state-default ui-corner-all" tabindex="0"></span>
                <span class="ui-slider-handle ui-state-default ui-corner-all" tabindex="0"></span>
              </div>
              <div class="row">
                <div class="col-6">
                  <p class="no-margin"><input id="amount" type="text" /></p>
                </div>
                <div class="col-6 text-right margin-25px-top">
                  <button class="btn btn-secondary btn--small">filter</button>
                </div>
              </div>
            </form>
          </div>
          <!--End Price Filter-->
          <!--Size Swatches-->
          <!-- <div class="sidebar_widget filterBox filter-widget size-swacthes">
            <div class="widget-title">
              <h2>Size</h2>
            </div>
            <div class="filter-color swacth-list">
              <ul>
                <li><span class="swacth-btn checked">XS</span></li>
                <li><span class="swacth-btn">S</span></li>
                <li><span class="swacth-btn">M</span></li>
                <li><span class="swacth-btn">L</span></li>
                <li><span class="swacth-btn">XL</span></li>
                <li><span class="swacth-btn">XXL</span></li>
                <li><span class="swacth-btn">XXXL</span></li>
              </ul>
            </div>
          </div> -->
          <!--End Size Swatches-->

          <!--Popular Products-->
          <!-- <div class="sidebar_widget">
            <div class="widget-title">
              <h2>Popular Products</h2>
            </div>
            <div class="widget-content">
              <div class="list list-sidebar-products">
                <div class="grid">
                  <div class="grid__item">
                    <div class="mini-list-item">
                      <div class="mini-view_image">
                        <a class="grid-view-item__link" href="#">
                          <img class="grid-view-item__image" src="assets/images/product-images/mini-product-img.jpg"
                            alt="" />
                        </a>
                      </div>
                      <div class="details"> <a class="grid-view-item__title" href="#">Cena Skirt</a>
                        <div class="grid-view-item__meta"><span class="product-price__price"><span
                              class="money">$173.60</span></span></div>
                      </div>
                    </div>
                  </div>
                  <div class="grid__item">
                    <div class="mini-list-item">
                      <div class="mini-view_image"> <a class="grid-view-item__link" href="#"><img
                            class="grid-view-item__image" src="assets/images/product-images/mini-product-img1.jpg"
                            alt="" /></a> </div>
                      <div class="details"> <a class="grid-view-item__title" href="#">Block Button Up</a>
                        <div class="grid-view-item__meta"><span class="product-price__price"><span
                              class="money">$378.00</span></span></div>
                      </div>
                    </div>
                  </div>
                  <div class="grid__item">
                    <div class="mini-list-item">
                      <div class="mini-view_image"> <a class="grid-view-item__link" href="#"><img
                            class="grid-view-item__image" src="assets/images/product-images/mini-product-img2.jpg"
                            alt="" /></a> </div>
                      <div class="details"> <a class="grid-view-item__title" href="#">Balda Button Pant</a>
                        <div class="grid-view-item__meta"><span class="product-price__price"><span
                              class="money">$278.60</span></span></div>
                      </div>
                    </div>
                  </div>
                  <div class="grid__item">
                    <div class="mini-list-item">
                      <div class="mini-view_image"> <a class="grid-view-item__link" href="#"><img
                            class="grid-view-item__image" src="assets/images/product-images/mini-product-img3.jpg"
                            alt="" /></a> </div>
                      <div class="details"> <a class="grid-view-item__title" href="#">Border Dress in Black/Silver</a>
                        <div class="grid-view-item__meta"><span class="product-price__price"><span
                              class="money">$228.00</span></span></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> -->
          <!--End Popular Products-->
          <!--Banner-->
          <!-- <div class="sidebar_widget static-banner">
            <img src="assets/images/side-banner-2.jpg" alt="" />
          </div> -->
          <!--Banner-->
        </div>
      </div>
      <!--End Sidebar-->
      <!--Main Content-->
      <div class="col-12 col-sm-12 col-md-9 col-lg-9 main-col">
        <div class="productList">
          <!--Toolbar-->
          <button type="button" class="btn btn-filter d-block d-md-none d-lg-none">
            Product Filters
          </button>
          <div class="toolbar">
            <div class="filters-toolbar-wrapper">
              <div class="row">
                <!-- <div
                  class="col-4 col-md-4 col-lg-4 filters-toolbar__item collection-view-as d-flex justify-content-start align-items-center">
                  <a href="shop-left-sidebar.html" title="Grid View" class="change-view change-view--active">
                    <img src="assets/images/grid.jpg" alt="Grid" />
                  </a>
                  <a href="shop-listview.html" title="List View" class="change-view">
                    <img src="assets/images/list.jpg" alt="List" />
                  </a>
                </div> -->
                <div
                  class="col-4 col-md-4 col-lg-4 text-center filters-toolbar__item filters-toolbar__item--count d-flex justify-content-center align-items-center">
                  <span class="filters-toolbar__product-count">Showing: <%= totalCount%></span>
                </div>
                <div class="col-4 col-md-4 col-lg-4 text-right">
                  <div class="filters-toolbar__item">
                    <label for="SortBy" class="hidden">Sort</label>
                    <select name="SortBy" onchange="handleOption(this)" id="SortBy"
                      class="filters-toolbar__input filters-toolbar__input--sort">
                      <option value="title-ascending" selected="selected">
                        Sort
                      </option>
                      <option>Price, low to high</option>
                      <option>Price, high to low</option>
                    </select>
                    <input class="collection-header__default-sort" type="hidden" value="manual" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--End Toolbar-->
          <div class="grid-products grid--view-items mainContent">
            <div class="row">
              <%products.forEach(product=> {%>
                <div class="col-6 col-sm-6 col-md-4 col-lg-4 item">
                  <!-- start product image -->
                  <div class="product-image">
                    <!-- start product image -->
                    <a href="/user_product_details_get/<%=product._id%>">

                      <img class="primary blur-up lazyload" data-src="<%= product.imageUrl[0].url%>"
                        src="<%= product.imageUrl[0].url%>" alt="image" title="product" />

                      <img class="hover blur-up lazyload" data-src="" src="<%= product.imageUrl[0].url%>" alt="image"
                        title="product" />

                    </a>

                    <div class="variants add">
                      <button class="btn btn-addto-cart" name="add" type="button" id="addtocart"
                        data-productid="<%= product._id%>">
                        Add to Cart
                      </button>
                    </div>
                    <div class="button-set">
                      <% const wishlisted=wishlistedProduct.find((p)=> p._id.toString() === product._id.toString()) %>
                        <% if (wishlisted) { %>
                          <div class="wishlist-btn">
                            <a style="cursor: pointer" class="wishlist add-to-wishlist" id="wishlist"
                              onclick="addToWishlist(event, '<%=product._id%>')">
                              <i class="fa-solid fa-heart" style="color: #e60505;"></i>
                            </a>
                          </div>
                          <%} else {%>
                            <div class="wishlist-btn">
                              <a style="cursor: pointer" class="wishlist add-to-wishlist" id="wishlist"
                                onclick="addToWishlist(event, '<%=product._id%>')">
                                <i class="icon anm anm-heart-l"></i>
                              </a>
                            </div>
                            <%}%>

                    </div>
                    <!-- end product button -->
                  </div>
                  <!-- end product image -->

                  <!--start product details -->
                  <div class="product-details text-center">
                    <!-- product name -->
                    <div class="product-name">
                      <a href="#">
                        <%=product.name%>
                      </a>
                    </div>
                    <!-- End product name -->
                    <!-- product price -->
                    <div class="product-price">
                      <!-- <span class="old-price">$500.00</span> -->
                      <span class="price">₹ <%= product.price%></span>
                    </div>
                    <!-- End product price -->

                    <!-- <div class="product-review">
                    <i class="font-13 fa fa-star"></i>
                    <i class="font-13 fa fa-star"></i>
                    <i class="font-13 fa fa-star"></i>
                    <i class="font-13 fa fa-star-o"></i>
                    <i class="font-13 fa fa-star-o"></i>
                  </div> -->
                    <!-- Variant -->
                    <!-- <ul class="swatches">
                    <li class="swatch medium rounded"><img src="assets/images/product-images/variant1.jpg"
                        alt="image" /></li>
                    <li class="swatch medium rounded"><img src="assets/images/product-images/variant2.jpg"
                        alt="image" /></li>
                    <li class="swatch medium rounded"><img src="assets/images/product-images/variant3.jpg"
                        alt="image" /></li>
                    <li class="swatch medium rounded"><img src="assets/images/product-images/variant4.jpg"
                        alt="image" /></li>
                    <li class="swatch medium rounded"><img src="assets/images/product-images/variant5.jpg"
                        alt="image" /></li>
                    <li class="swatch medium rounded"><img src="assets/images/product-images/variant6.jpg"
                        alt="image" /></li>
                  </ul> -->
                    <!-- End Variant -->
                  </div>
                  <!-- End product details -->
                </div>
                <%}) %>
            </div>
          </div>
        </div>
        <hr class="clear" />

        <!-- <div class="pagination">
          <ul>
            <li class="page"><a href="#">1</a></li>
            <li><a href="#">2</a></li>
            <li class="next"><a href="#"><i class="fa fa-caret-right" aria-hidden="true"></i></a></li>
          </ul>
        </div> -->

        <div class="pagination">
          <ul>
            <li>
              <% if (currentPage> 1) { %>
                <a class="page" href="?page=<%= currentPage - 1 %>">Previous</a>
                <% } %>
            </li>
            <% for (let page=1; page <=totalPages; page++) { %>
              <li>
                <a class="page" href="?page=<%= page %>">
                  <%= page %>
                </a>
              </li>
              <% } %>
                <li>
                  <% if (currentPage < totalPages) { %>
                    <a class="page" href="?page=<%= currentPage + 1 %>">Next</a>
                    <% } %>
                </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <%-include('footer') -%>

    <script src="/js/axios.min.js"></script>
    <script>
      let currentPage = 1;
      const productPerPage = 6;
      document.getElementById('wishlist').addEventListener('click', addToWishlist)
      async function addToWishlist(event, productId) {
        event.preventDefault;
        try {
          const response = await axios.post(`/user_wishlist_post/${productId}`);

        } catch (err) {
          console.log(err);
        }
      }

      document.getElementById('addtocart').addEventListener('click', addToCart
        // const productid = event.target.dataset.productid;
        // addToCart(event, productid);
      );

      async function addToCart(event, productid) {
        event.preventDefault();
        console.log(productid)
        try {
          const response = await axios.post(`/user_add_to_cart_post/${productid}`);
        } catch (err) {
          console.log(err);
        }
      }


      document.querySelectorAll(".categoryLink").forEach(category => {
        category.addEventListener('click', function (event) {
          event.preventDefault();
          const categoryId = category.parentElement.dataset.categoryid;
          filterByCategory(categoryId);
        })
      })

      async function filterByCategory(categoryId, page) {
        try {
          const response = await axios.post(`/user_filter_category_post/${categoryId}`);
          const categorizedProduct = response.data.categorizedProduct;
          const wishlistedProduct = response.data.wishlistedProduct;
          const page = response.data.page;
          const totalPages = response.data.totalPages;
          updatedProducts(categorizedProduct, wishlistedProduct);
          currentPage = page;
        } catch (err) {
          console.log(err);
        }
      }

      function updatedProducts(products, wishlistedProduct) {
        const mainContent = document.getElementsByClassName('grid-products grid--view-items')[0];
        mainContent.innerHTML = '';

        const rowElement = document.createElement('div');
        rowElement.classList.add('row');


        products.forEach((product) => {
          const productContainer = document.createElement('div');
          productContainer.classList.add('col-6', 'col-sm-6', 'col-md-4', 'col-lg-4', 'item');

          const productImage = document.createElement('div');
          productImage.classList.add('product-image');
          productImage.innerHTML = `
      <a href="/user_product_details_get/${product._id}">
        <img class="primary blur-up lazyload" data-src="${product.imageUrl[0].url}"
          src="${product.imageUrl[0].url}" alt="image" title="product" />
        <img class="hover blur-up lazyload" data-src="${product.imageUrl[0].url}" src="${product.imageUrl[0].url}" alt="image"
          title="product" />
      </a>
      <div class="variants add">
        <button class="btn btn-addto-cart" name="add" type="button" id="addtocart"
          data-productid="${product._id}">
          Add to Cart
        </button>
      </div>
      <div class="button-set">
        ${wishlistedProduct.some((p) => p._id.toString() === product._id.toString())
              ? `<div class="wishlist-btn">
                 <a style="cursor: pointer" class="wishlist add-to-wishlist" id="wishlist"
                   onclick="addToWishlist(event, '${product._id}')">
                   <i class="fa-solid fa-heart" style="color: #e60505;"></i>
                 </a>
               </div>`
              : `<div class="wishlist-btn">
                 <a style="cursor: pointer" class="wishlist add-to-wishlist" id="wishlist"
                   onclick="addToWishlist(event, '${product._id}')">
                   <i class="icon anm anm-heart-l"></i>
                 </a>
               </div>`
            }
      </div>`;

          const productDetails = document.createElement('div');
          productDetails.classList.add('product-details', 'text-center');
          productDetails.innerHTML = `
      <div class="product-name">
        <a href="#">
          ${product.name}
        </a>
      </div>
      <div class="product-price">
        <span class="price">₹ ${product.price}</span>
      </div>
    `;

          productContainer.appendChild(productImage);
          productContainer.appendChild(productDetails);
          rowElement.appendChild(productContainer);
          
        });
        mainContent.appendChild(rowElement);
      };



    </script>